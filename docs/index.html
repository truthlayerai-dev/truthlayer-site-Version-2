<!-- docs/index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TruthLayer — Claim Check</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">TL</div>
      <div>
        <div class="title">TruthLayer</div>
        <div class="subtitle">Claim Check (Prototype)</div>
      </div>
    </div>

    <div class="right">
      <span class="pill" id="healthPill">Worker: checking…</span>
      <a class="ghost" href="#how" id="howLink">How it works</a>
    </div>
  </header>

  <main class="wrap">
    <section class="grid">
      <!-- Left: input -->
      <div class="panel">
        <h2>Check a claim</h2>
        <p class="muted">
          Paste a claim. Optionally add evidence links (one per line). Then hit <b>Check</b>.
        </p>

        <label class="label" for="claim">Claim</label>
        <textarea id="claim" class="input" rows="4" placeholder="Example: Phoenix is the capital of Arizona"></textarea>

        <label class="label" for="evidence">Evidence links (one per line)</label>
        <textarea id="evidence" class="input" rows="4" placeholder="https://example.com/source&#10;https://another-source.com/article"></textarea>

        <div class="row">
          <button class="btn" id="checkBtn">Check</button>
          <button class="btn secondary" id="clearBtn">Clear</button>
          <span class="status" id="status">Ready.</span>
        </div>

        <div class="chips">
          <button class="chip" data-example="az">AZ capital</button>
          <button class="chip" data-example="treasury">Treasury debt</button>
          <button class="chip" data-example="random">No-links test</button>
        </div>

        <div class="divider"></div>

        <div id="how" class="how">
          <h3>How it works (v1)</h3>
          <ol>
            <li>You submit a claim + optional links.</li>
            <li>The Worker returns a verdict + confidence + “why”.</li>
            <li>If you include links, they show up as citations (user-provided).</li>
          </ol>
          <p class="muted tiny">
            This is a prototype scoring signal. Step 2 later can auto-fetch citations with SERPER or other tools.
          </p>
        </div>
      </div>

      <!-- Right: results -->
      <div class="panel">
        <h2>Result</h2>

        <div class="resultCard" id="resultCard">
          <div class="resultTop">
            <div>
              <div class="kicker">VERDICT</div>
              <div class="verdict" id="verdict">—</div>
            </div>
            <div class="badge" id="badge">—</div>
          </div>

          <div class="kicker">CONFIDENCE</div>
          <div class="bar">
            <div class="barFill" id="barFill"></div>
          </div>
          <div class="barMeta">
            <span class="muted tiny" id="barLeft">Prototype</span>
            <span class="percent" id="percent">0%</span>
          </div>

          <div class="divider"></div>

          <div class="kicker">WHY</div>
          <ul class="bullets" id="why"></ul>

          <div class="divider"></div>

          <div class="kicker">CITATIONS</div>
          <div class="citations" id="citations">
            <div class="muted">None</div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <button class="btn secondary" id="copyBtn">Copy result</button>
            <span class="muted tiny" id="debug"></span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ✅ YOUR WORKER ENDPOINT
   const API = "https://YOUR-WORKER.workers.dev/api/check";
const HEALTH = "https://YOUR-WORKER.workers.dev/"

    const el = (id) => document.getElementById(id);

    const claimEl = el("claim");
    const evidenceEl = el("evidence");
    const statusEl = el("status");
    const healthPill = el("healthPill");

    const verdictEl = el("verdict");
    const badgeEl = el("badge");
    const barFillEl = el("barFill");
    const percentEl = el("percent");
    const whyEl = el("why");
    const citationsEl = el("citations");
    const debugEl = el("debug");

    function setStatus(text, kind="ok") {
      statusEl.textContent = text;
      statusEl.className = "status " + kind;
    }

    function setHealth(text, good) {
      healthPill.textContent = text;
      healthPill.className = "pill " + (good ? "good" : "bad");
    }

    function cleanLines(text) {
      return text
        .split("\n")
        .map(s => s.trim())
        .filter(Boolean);
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    function renderResult(data) {
      verdictEl.textContent = data.verdict ?? "—";
      badgeEl.textContent = data.label ?? "—";

      const conf = Number(data.confidence ?? 0);
      percentEl.textContent = conf + "%";
      barFillEl.style.width = Math.max(0, Math.min(100, conf)) + "%";

      // why bullets
      whyEl.innerHTML = "";
      const whyList = Array.isArray(data.why) ? data.why : [];
      for (const item of whyList) {
        const li = document.createElement("li");
        li.textContent = item;
        whyEl.appendChild(li);
      }
      if (!whyList.length) {
        const li = document.createElement("li");
        li.textContent = "No explanation returned.";
        whyEl.appendChild(li);
      }

      // citations
      const cits = Array.isArray(data.citations) ? data.citations : [];
      if (!cits.length) {
        citationsEl.innerHTML = '<div class="muted">None</div>';
      } else {
        citationsEl.innerHTML = "";
        cits.forEach((c) => {
          const a = document.createElement("a");
          a.href = c.url || "#";
          a.target = "_blank";
          a.rel = "noreferrer";
          a.className = "cite";
          a.innerHTML = `<div class="citeTitle">${escapeHtml(c.title || "Source")}</div>
                         <div class="citeUrl">${escapeHtml(c.url || "")}</div>
                         <div class="citeSnippet">${escapeHtml(c.snippet || "")}</div>`;
          citationsEl.appendChild(a);
        });
      }

      // badge color vibe
      const label = (data.label || "").toLowerCase();
      badgeEl.className = "badge " + (
        label.includes("strong") ? "b-good" :
        label.includes("some") ? "b-mid" :
        "b-bad"
      );

      debugEl.textContent = "";
    }

    async function checkHealth() {
      try {
        const r = await fetch(HEALTH, { method: "GET" });
        const j = await r.json();
        if (j && j.ok) setHealth("Worker: OK", true);
        else setHealth("Worker: weird response", false);
      } catch (e) {
        setHealth("Worker: unreachable", false);
      }
    }

    async function checkClaim() {
      const claim = claimEl.value.trim();
      const evidenceLinks = cleanLines(evidenceEl.value);

      if (!claim) {
        setStatus("Type a claim first.", "bad");
        return;
      }

      setStatus("Checking…", "wait");

      try {
        const res = await fetch(API, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ claim, evidenceLinks })
        });

        const text = await res.text();
        let data;
        try { data = JSON.parse(text); }
        catch { throw new Error("Bad JSON: " + text.slice(0,120)); }

        if (!res.ok || !data.ok) {
          debugEl.textContent = data?.error ? ("Error: " + data.error) : ("HTTP " + res.status);
          setStatus("Error returned. See debug.", "bad");
          return;
        }

        renderResult(data);
        setStatus("Done.", "ok");
      } catch (err) {
        debugEl.textContent = "Fetch failed: " + (err?.message || String(err));
        setStatus("Status: error", "bad");
      }
    }

    function clearAll() {
      claimEl.value = "";
      evidenceEl.value = "";
      setStatus("Cleared.", "ok");
      renderResult({ verdict:"—", label:"—", confidence:0, why:[], citations:[] });
    }

    function copyResult() {
      const payload = {
        claim: claimEl.value.trim(),
        verdict: verdictEl.textContent,
        confidence: percentEl.textContent,
        why: Array.from(whyEl.querySelectorAll("li")).map(li => li.textContent),
        citations: Array.from(citationsEl.querySelectorAll("a")).map(a => a.href)
      };
      navigator.clipboard.writeText(JSON.stringify(payload, null, 2))
        .then(() => setStatus("Copied result JSON to clipboard.", "ok"))
        .catch(() => setStatus("Copy failed (browser blocked).", "bad"));
    }

    // examples
    const examples = {
      az: {
        claim: "Phoenix is the capital of Arizona.",
        evidence: "https://az.gov/"
      },
      treasury: {
        claim: "The U.S. Treasury publishes the national debt as a dataset called 'Debt to the Penny.'",
        evidence: "https://fiscaldata.treasury.gov/datasets/debt-to-the-penny/debt-to-the-penny"
      },
      random: {
        claim: "The Great Wall of China is visible from space with the naked eye.",
        evidence: ""
      }
    };

    document.querySelectorAll(".chip").forEach(btn => {
      btn.addEventListener("click", () => {
        const key = btn.dataset.example;
        claimEl.value = examples[key].claim;
        evidenceEl.value = examples[key].evidence;
        setStatus("Example loaded.", "ok");
      });
    });

    el("checkBtn").addEventListener("click", checkClaim);
    el("clearBtn").addEventListener("click", clearAll);
    el("copyBtn").addEventListener("click", copyResult);

    // allow Ctrl+Enter to check
    [claimEl, evidenceEl].forEach(t => {
      t.addEventListener("keydown", (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === "Enter") checkClaim();
      });
    });

    // boot
    checkHealth();
    renderResult({ verdict:"—", label:"—", confidence:0, why:[], citations:[] });
  </script>
</body>
</html>
