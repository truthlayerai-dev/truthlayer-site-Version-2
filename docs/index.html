<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TruthLayer — Claim Check</title>
  <link rel="stylesheet" href="./styles.css" />
</head>

<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <div class="logo">TL</div>
        <div class="brandtext">
          <div class="name">TruthLayer</div>
          <div class="tag">Claim Check (v1)</div>
        </div>
      </div>

      <nav class="nav">
        <button class="navbtn" id="howBtn">How it works</button>
        <a class="navbtn ghost" href="#early">Early Access</a>
      </nav>
    </header>

    <main class="grid">
      <!-- Left: chat-like input -->
      <section class="panel">
        <div class="panelhead">
          <h1>Claim Check</h1>
          <p class="muted">Paste a claim. Add links if you have them. We’ll return a verdict + citations.</p>
        </div>

        <div class="composer">
          <label class="label" for="claimInput">Claim</label>
          <textarea id="claimInput" rows="3" placeholder="Example: The U.S. national debt is tracked publicly by the Treasury."></textarea>

          <label class="label" for="linksInput">Optional evidence links (one per line)</label>
          <textarea id="linksInput" rows="2" placeholder="https://example.com/source-1
https://example.com/source-2"></textarea>

          <div class="actions">
            <button id="checkBtn" class="btn primary">Check</button>
            <button id="clearBtn" class="btn">Clear</button>
            <div class="hint" id="statusHint">Connected to TruthLayer Worker ✅</div>
          </div>
        </div>

        <div class="examples">
          <div class="label">Quick examples</div>
          <div class="chips" id="chips"></div>
        </div>

        <div class="footnote">
          Prototype note: If SERPER_API_KEY isn’t set yet, you’ll see “Prototype mode” (no auto-citations).
        </div>
      </section>

      <!-- Right: result card -->
      <section class="panel">
        <div class="panelhead">
          <h2>Result</h2>
          <p class="muted">Verdict, confidence, why, missing info, and citations.</p>
        </div>

        <div id="result" class="result">
          <div class="empty">
            <div class="emptyTitle">Run your first check</div>
            <div class="emptyText">Type a claim on the left and hit <b>Check</b>.</div>
          </div>
        </div>

        <div id="early" class="early">
          <div class="earlyCard">
            <div class="earlyTitle">Early access</div>
            <div class="earlyText">Drop your email and we’ll notify you when v1 goes live.</div>

            <form id="earlyForm" class="earlyForm">
              <input id="earlyEmail" type="email" placeholder="you@email.com" required />
              <button class="btn primary" type="submit">Notify me</button>
            </form>

            <div class="muted tiny">
              This uses an email link to <b>truthlayer.ai@gmail.com</b> for now (no database yet).
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Modal -->
    <dialog id="howModal" class="modal">
      <div class="modalBody">
        <div class="modalHead">
          <div class="modalTitle">How TruthLayer v1 works</div>
          <button class="x" id="closeHow">✕</button>
        </div>
        <ul class="list">
          <li><b>You</b> paste a claim (and optional links).</li>
          <li><b>Worker API</b> returns a verdict + confidence.</li>
          <li>If SERPER is enabled, it also returns <b>citations + snippets</b>.</li>
          <li>We show <b>what’s missing</b> to make the claim testable.</li>
        </ul>
        <div class="muted tiny">Next step: add SERPER_API_KEY so citations appear automatically.</div>
      </div>
    </dialog>

  </div>

  <script>
    // ✅ Your Cloudflare Worker base URL
    const API_BASE = "https://rapid-flower-be72truthlayer.truthlayer-ai.workers.dev";

    const els = {
      claim: document.getElementById("claimInput"),
      links: document.getElementById("linksInput"),
      check: document.getElementById("checkBtn"),
      clear: document.getElementById("clearBtn"),
      result: document.getElementById("result"),
      hint: document.getElementById("statusHint"),
      chips: document.getElementById("chips"),
      howBtn: document.getElementById("howBtn"),
      howModal: document.getElementById("howModal"),
      closeHow: document.getElementById("closeHow"),
      earlyForm: document.getElementById("earlyForm"),
      earlyEmail: document.getElementById("earlyEmail"),
    };

    const EXAMPLES = [
      {
        label: "Treasury tracks U.S. debt",
        claim: "The U.S. national debt is tracked publicly by the U.S. Treasury.",
        links: ""
      },
      {
        label: "Bitcoin supply cap",
        claim: "Bitcoin has a maximum supply cap of 21 million coins.",
        links: ""
      },
      {
        label: "Water boils at 100°C",
        claim: "At sea level, pure water boils at 100°C (212°F).",
        links: ""
      },
      {
        label: "Arizona capital",
        claim: "Phoenix is the capital of Arizona.",
        links: ""
      },
      {
        label: "Add your own link test",
        claim: "The current U.S. debt is published as a dataset.",
        links: "https://fiscaldata.treasury.gov/datasets/debt-to-the-penny/debt-to-the-penny"
      }
    ];

    function mountChips() {
      els.chips.innerHTML = "";
      EXAMPLES.forEach(x => {
        const b = document.createElement("button");
        b.className = "chip";
        b.textContent = x.label;
        b.addEventListener("click", () => {
          els.claim.value = x.claim;
          els.links.value = x.links;
          els.claim.focus();
        });
        els.chips.appendChild(b);
      });
    }

    function setLoading(isLoading) {
      els.check.disabled = isLoading;
      els.clear.disabled = isLoading;
      els.claim.disabled = isLoading;
      els.links.disabled = isLoading;
      els.hint.textContent = isLoading ? "Checking…" : "Connected to TruthLayer Worker ✅";
    }

    function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

    function badgeFor(conf) {
      if (conf >= 80) return { text: "Strong support", cls: "good" };
      if (conf >= 55) return { text: "Some support", cls: "mid" };
      return { text: "Weak support", cls: "bad" };
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    async function checkClaimWithAPI(claim, evidenceLinks) {
      const res = await fetch(`${API_BASE}/api/check`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ claim, evidence: evidenceLinks })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data?.error || "API error");
      return data;
    }

    function renderResult(data) {
      const confidence = clamp(Number(data.confidence || 0), 0, 100);
      const badge = badgeFor(confidence);

      const citations = Array.isArray(data.citations) ? data.citations : [];
      const why = Array.isArray(data.why) ? data.why : [];
      const missing = Array.isArray(data.missing) ? data.missing : [];

      const citationsHtml = citations.length
        ? citations.map(c => `
          <a class="cite" href="${escapeHtml(c.url)}" target="_blank" rel="noopener">
            <div class="citeTitle">${escapeHtml(c.title || c.url)}</div>
            ${c.snippet ? `<div class="citeSnippet">${escapeHtml(c.snippet)}</div>` : ""}
            <div class="citeUrl">${escapeHtml(c.url)}</div>
          </a>
        `).join("")
        : `<div class="muted">No citations returned yet. (If SERPER_API_KEY is not set, this is expected.)</div>`;

      const list = (arr) =>
        arr.length ? `<ul class="bullets">${arr.map(x => `<li>${escapeHtml(x)}</li>`).join("")}</ul>`
                  : `<div class="muted">None</div>`;

      els.result.innerHTML = `
        <div class="card">
          <div class="cardTop">
            <div>
              <div class="k">VERDICT</div>
              <div class="verdict">${escapeHtml(data.verdict || "Unclear")}</div>
            </div>
            <div class="pill ${badge.cls}">${badge.text}</div>
          </div>

          <div class="barBlock">
            <div class="k">CONFIDENCE</div>
            <div class="barRow">
              <div class="bar"><div class="fill" style="width:${confidence}%"></div></div>
              <div class="pct">${confidence}%</div>
            </div>
          </div>

          <div class="block">
            <div class="k">BRIEF</div>
            <div class="text">${escapeHtml(data.brief || "")}</div>
          </div>

          <div class="block">
            <div class="k">WHY</div>
            ${list(why)}
          </div>

          <div class="block">
            <div class="k">WHAT’S MISSING</div>
            ${list(missing)}
          </div>

          <div class="block">
            <div class="k">CITATIONS</div>
            <div class="cites">${citationsHtml}</div>
          </div>

          <div class="tiny muted center">
            TruthLayer v1: citations come from the Worker. Add SERPER_API_KEY to enable live web results.
          </div>
        </div>
      `;
    }

    function renderError(msg) {
      els.result.innerHTML = `
        <div class="card">
          <div class="verdict">Error</div>
          <div class="muted">${escapeHtml(msg)}</div>
          <div class="tiny muted">If this persists, your Worker might be deployed but missing /api/check.</div>
        </div>
      `;
    }

    // Event wiring
    els.check.addEventListener("click", async () => {
      const claim = els.claim.value.trim();
      const evidenceLinks = els.links.value
        .split("\n")
        .map(s => s.trim())
        .filter(Boolean);

      if (!claim) {
        renderError("Type a claim first.");
        els.claim.focus();
        return;
      }

      setLoading(true);
      try {
        const data = await checkClaimWithAPI(claim, evidenceLinks);
        renderResult(data);
      } catch (err) {
        renderError(String(err));
      } finally {
        setLoading(false);
      }
    });

    els.clear.addEventListener("click", () => {
      els.claim.value = "";
      els.links.value = "";
      els.result.innerHTML = `
        <div class="empty">
          <div class="emptyTitle">Cleared</div>
          <div class="emptyText">Drop a claim and hit <b>Check</b>.</div>
        </div>
      `;
      els.claim.focus();
    });

    // Enter = check (Ctrl+Enter for newline)
    els.claim.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        els.check.click();
      }
    });

    els.howBtn.addEventListener("click", () => els.howModal.showModal());
    els.closeHow.addEventListener("click", () => els.howModal.close());

    els.earlyForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const email = els.earlyEmail.value.trim();
      if (!email) return;

      const subject = encodeURIComponent("TruthLayer — Early Access");
      const body = encodeURIComponent(
        `Please add me to the TruthLayer early access list.\n\nEmail: ${email}\n\nSent from the TruthLayer v1 site.`
      );

      // Simple v1: mailto (no backend storage yet)
      window.location.href = `mailto:truthlayer.ai@gmail.com?subject=${subject}&body=${body}`;
      els.earlyEmail.value = "";
    });

    mountChips();
  </script>
</body>
</html>
