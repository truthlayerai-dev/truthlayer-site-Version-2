<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TruthLayer</title>
  <meta name="description" content="Verify claims fast with sources." />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sb-top">
        <div class="brand">
          <div class="logo-dot"></div>
          <div>
            <div class="brand-name">TruthLayer</div>
            <div class="brand-sub">Fast claim checks</div>
          </div>
        </div>

        <button id="newPulseBtn" class="sb-btn" type="button">+ New Pulse</button>
      </div>

      <div class="sb-section">
        <div class="sb-label">RECENT</div>
        <button class="chat-item active" type="button" disabled>
          <div class="chat-title">Local Prototype</div>
          <div class="chat-sub">Brief results + optional details</div>
        </button>
      </div>

      <div class="sb-footer">
        <div class="tiny">v1 • prototype</div>
        <a class="tiny link" href="#early">Early access</a>
      </div>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="top-title">Claim Check</div>
        <div class="top-actions">
          <button class="ghost" type="button" onclick="location.hash='how'">How it works</button>
          <button class="primary" type="button" onclick="location.hash='early'">Early Access</button>
        </div>
      </header>

      <section id="chat" class="chat">
        <div id="how" class="msg sys">
          <div class="bubble">
            Paste a claim (optionally add links). You’ll get a <b>brief verdict</b> first — details are one click.
          </div>
        </div>

        <div class="msg sys">
          <div class="bubble">
            Tip: If you paste links under your claim, TruthLayer will treat them as evidence and raise confidence.
          </div>
        </div>

        <div id="early" class="waitlist">
          <div class="wl-card">
            <div class="wl-title">Early access</div>
            <div class="wl-sub">Email and we’ll notify you when v1 goes live.</div>
            <a class="primary wide"
               href="mailto:truthlayer.ai@gmail.com?subject=TruthLayer%20Early%20Access&body=Name:%0AEmail:%0AWhat%20do%20you%20want%20to%20verify%20most:%0A">
              Email: truthlayer.ai@gmail.com
            </a>
            <div class="tiny">We’ll add a form later.</div>
          </div>
        </div>
      </section>

      <footer class="composer">
        <div class="input-wrap">
          <input id="claimInput" class="input" placeholder="Paste a claim… (optional links below)" autocomplete="off" />
          <button id="checkBtn" class="send" type="button">Check</button>
        </div>
        <div class="tiny center">Prototype: brief result is based on formatting + evidence you provide. Step 2 adds auto-citations.</div>
      </footer>
    </main>
  </div>

  <script>
    console.log("TruthLayer brief-mode v1 loaded");

    const chat = document.getElementById('chat');
    const input = document.getElementById('claimInput');
    const checkBtn = document.getElementById('checkBtn');
    const newPulseBtn = document.getElementById('newPulseBtn');

    function esc(str) {
      return String(str).replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    function insertAboveEarly(node) {
      const early = document.getElementById('early');
      if (early) chat.insertBefore(node, early);
      else chat.appendChild(node);
    }

    function addMsg(role, innerHTML) {
      const wrap = document.createElement('div');
      wrap.className = `msg ${role}`;
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerHTML = innerHTML;
      wrap.appendChild(bubble);

      insertAboveEarly(wrap);
      wrap.scrollIntoView({ behavior: 'smooth', block: 'end' });
      return wrap;
    }

    function addUser(text) { addMsg('user', esc(text)); }

    function extractUrls(text) {
      const urls = text.match(/https?:\/\/[^\s)]+/g) || [];
      const cleaned = urls.map(u => u.replace(/[.,;!?]+$/, ''));
      return Array.from(new Set(cleaned));
    }

    function stripUrls(text) {
      return text.replace(/https?:\/\/[^\s)]+/g, '').replace(/\n{3,}/g, '\n\n').trim();
    }

    function verdictFromScore(score) {
      if (score >= 80) return { verdict: "Likely true", badge: "Strong" };
      if (score >= 55) return { verdict: "Mixed / uncertain", badge: "Some" };
      return { verdict: "Unclear / likely false", badge: "Weak" };
    }

    function estimateScore(claim, urls) {
      const t = claim.trim();
      const len = t.length;

      const hasNumbers = /\d/.test(t);
      const hasDateWord = /\b(20\d{2}|19\d{2}|jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)\b/i.test(t);
      const absolutist = /\b(always|never|everyone|no one|100%)\b/i.test(t);

      let score = 20;

      // length adds up to +25
      score += Math.min(25, Math.floor(len / 8));

      // specifics
      if (hasNumbers) score += 10;
      if (hasDateWord) score += 8;

      // evidence links
      if (urls.length === 1) score += 25;
      if (urls.length >= 2) score += 35;

      // penalties
      if (len > 240) score -= 10;
      if (absolutist) score -= 8;

      return Math.max(5, Math.min(95, score));
    }

    function briefSummary(claim, urls, score) {
      // one-liner + one supporting sentence (max 2 lines)
      const hasLinks = urls.length > 0;
      const hasSpecifics = /\d/.test(claim) || /\b(20\d{2}|19\d{2})\b/.test(claim);

      if (!hasLinks) {
        return {
          line1: "No sources provided — this is unverified.",
          line2: "Add 1–2 credible links (official docs or reputable reporting) to raise confidence."
        };
      }

      if (score >= 80) {
        return {
          line1: "Looks verifiable and you provided evidence.",
          line2: "Next: cross-check the links for direct support of the exact claim wording."
        };
      }

      if (!hasSpecifics) {
        return {
          line1: "You provided links, but the claim is still a bit vague.",
          line2: "Add specifics (who/what/when/where) so sources can confirm the same statement."
        };
      }

      return {
        line1: "Some support based on the evidence you provided.",
        line2: "To strengthen it, confirm with a primary source or an independent second outlet."
      };
    }

    function missingInfo(claim, urls) {
      const misses = [];
      if (!urls.length) misses.push("At least 1 credible source link");
      if (!/\d/.test(claim)) misses.push("Numbers or specific details");
      if (!/\b(20\d{2}|19\d{2})\b/.test(claim)) misses.push("A date/timeframe");
      if (claim.length < 25) misses.push("Clearer wording (who did what)");
      return misses;
    }

    function checklist(urls) {
      const list = [];
      list.push("Confirm the source is credible (official / reputable).");
      if (urls.length < 2) list.push("Add a second independent source (avoid single-source confidence).");
      list.push("Verify the claim appears directly in the source (not implied).");
      list.push("Check date + context (older article ≠ current status).");
      return list;
    }

    function renderLinks(urls, max = 2) {
      if (!urls.length) return `<span class="muted">None</span>`;
      const shown = urls.slice(0, max).map(u => `<a href="${esc(u)}" target="_blank" rel="noreferrer">${esc(u)}</a>`).join('');
      const more = urls.length > max ? `<div class="muted">+${urls.length - max} more link(s) in details</div>` : '';
      return shown + more;
    }

    function addBotCard({ claimText, urls, score }) {
      const v = verdictFromScore(score);
      const brief = briefSummary(claimText, urls, score);
      const miss = missingInfo(claimText, urls);
      const cl = checklist(urls);

      const whyBrief = `
        <div class="brief">
          <div class="brief-line1">${esc(brief.line1)}</div>
          <div class="brief-line2">${esc(brief.line2)}</div>
        </div>
      `;

      const missHtml = miss.length
        ? `<ul>${miss.map(x => `<li>${esc(x)}</li>`).join('')}</ul>`
        : `<div class="muted">Nothing obvious missing.</div>`;

      const clHtml = `<ul>${cl.map(x => `<li>${esc(x)}</li>`).join('')}</ul>`;

      const id = "d_" + Math.random().toString(16).slice(2);

      const card = addMsg('bot', `
        <div class="card">
          <div class="card-top">
            <div>
              <div class="meta">Verdict</div>
              <div class="verdict">${esc(v.verdict)}</div>
            </div>
            <span class="pill">${esc(v.badge)} support</span>
          </div>

          <div class="meta">Confidence</div>
          <div class="bar-row">
            <div class="bar"><div class="bar-fill" style="width:${score}%"></div></div>
            <div class="bar-num">${score}%</div>
          </div>

          <div class="meta">Brief</div>
          ${whyBrief}

          <div class="meta">Evidence</div>
          <div class="sources">${renderLinks(urls, 2)}</div>

          <div class="actions">
            <button class="mini" data-toggle="${id}" type="button">Show details</button>
            <button class="mini" data-copy="1" type="button">Copy</button>
          </div>

          <div id="${id}" class="details hidden">
            <div class="details-grid">
              <div class="details-box">
                <div class="meta">Parsed claim</div>
                <div class="mono">${esc(claimText || "(no claim text detected)")}</div>
              </div>

              <div class="details-box">
                <div class="meta">All evidence links</div>
                <div class="sources">
                  ${urls.length ? urls.map(u => `<a href="${esc(u)}" target="_blank" rel="noreferrer">${esc(u)}</a>`).join('') : `<span class="muted">None</span>`}
                </div>
              </div>

              <div class="details-box">
                <div class="meta">What’s missing</div>
                ${missHtml}
              </div>

              <div class="details-box">
                <div class="meta">Verification checklist</div>
                ${clHtml}
              </div>
            </div>

            <div class="tip">Step 2: TruthLayer will auto-fetch sources + show citations/snippets.</div>
          </div>
        </div>
      `);

      // Wire buttons inside the last added card
      const last = card.querySelector('.card');
      const toggleBtn = last.querySelector('[data-toggle]');
      const copyBtn = last.querySelector('[data-copy]');
      const details = last.querySelector('#' + id);

      toggleBtn.addEventListener('click', () => {
        const isHidden = details.classList.contains('hidden');
        details.classList.toggle('hidden');
        toggleBtn.textContent = isHidden ? "Hide details" : "Show details";
      });

      copyBtn.addEventListener('click', async () => {
        const text =
`TruthLayer — ${v.verdict} (${score}%)
Brief: ${brief.line1} ${brief.line2}
Evidence: ${urls.length ? urls.join(' | ') : 'None'}
Claim: ${claimText}`;

        try {
          await navigator.clipboard.writeText(text);
          copyBtn.textContent = "Copied";
          setTimeout(() => (copyBtn.textContent = "Copy"), 900);
        } catch {
          copyBtn.textContent = "Copy failed";
          setTimeout(() => (copyBtn.textContent = "Copy"), 900);
        }
      });
    }

    function handleSend() {
      const raw = input.value.trim();
      if (!raw) return;

      addUser(raw);
      input.value = '';
      input.focus();

      const urls = extractUrls(raw);
      const claimText = stripUrls(raw);

      const typing = addMsg('sys', `<span class="muted">Analyzing…</span>`);
      setTimeout(() => {
        typing.remove();
        const score = estimateScore(claimText || raw, urls);
        addBotCard({ claimText, urls, score });
      }, 350);
    }

    checkBtn.addEventListener('click', handleSend);
    input.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSend(); });

    newPulseBtn.addEventListener('click', () => {
      const msgs = Array.from(chat.querySelectorAll('.msg'));
      msgs.forEach((m, idx) => { if (idx >= 2) m.remove(); });
      addMsg('sys', `<span class="muted">New Pulse started. Paste a claim.</span>`);
      input.value = '';
      input.focus();
    });

    window.addEventListener('load', () => input.focus());
  </script>
</body>
</html>
